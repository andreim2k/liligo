#!/usr/bin/env python3
"""
LilyGo T-Dongle-S3 Bluetooth Keyboard Bridge Client

Connects to the T-Dongle-S3 over BLE and sends keystrokes to be typed
on the target computer via USB HID.
"""

import argparse
import asyncio
import sys
import signal
import subprocess
import os
from typing import Optional

from bleak import BleakClient, BleakScanner
from bleak.backends.device import BLEDevice


def get_clipboard():
    """Get clipboard content on macOS, preserving all formatting."""
    try:
        # Use text=False to get raw bytes, then decode to preserve all chars
        result = subprocess.run(['pbpaste'], capture_output=True, text=False)
        # Decode as UTF-8, preserving newlines and special chars
        return result.stdout.decode('utf-8', errors='replace')
    except:
        return None


def is_binary_file(file_path: str, sample_size: int = 8192) -> bool:
    """Check if a file is binary by looking for null bytes."""
    try:
        with open(file_path, 'rb') as f:
            chunk = f.read(sample_size)
            if b'\x00' in chunk:
                return True
            # Check for high ratio of non-text bytes
            text_chars = bytearray({7, 8, 9, 10, 12, 13, 27} | set(range(0x20, 0x100)))
            non_text = sum(1 for b in chunk if b not in text_chars)
            return non_text / len(chunk) > 0.30 if chunk else False
    except:
        return True

